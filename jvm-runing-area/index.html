<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>jvm运行时数据区 - mrhy&#039;s blogs</title><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#3273dc"><meta name="application-name" content="mrhy&#039;s blog"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="msapplication-TileColor" content="#3273dc"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="mrhy&#039;s blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="今天重温jvm运行时的数据区，写成文档，使自己有更深的理解"><meta property="og:type" content="blog"><meta property="og:title" content="jvm运行时数据区"><meta property="og:url" content="https://mrhy1996.github.io/jvm-runing-area/"><meta property="og:site_name" content="mrhy&#039;s blogs"><meta property="og:description" content="今天重温jvm运行时的数据区，写成文档，使自己有更深的理解"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/image-20221021154626190.png"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/image-20221027090344896.png"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/format,png.png"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/format,png-20221030101335535.png"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/format,png-20221030185348926.png"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/format,png-20221030185613809.png"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/format,png-20221030185622802.png"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/format,png-20221030185630479.png"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/format,png-20221030185436860.png"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/format,png-20221030185455197.png"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/format,png-20221030185526481.png"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/format,png-20221030185556654.png"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/jvm运行时数据区/image-20221031213509199.png"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/image-20221031213556129.png"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/image-20221031213941263.png"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/image-20221031214856874.png"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/image-20221102092249927.png"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/image-20221103145838303.png"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/image-20221103145830147.png"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/image-20221105093134349.png"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/image-20221105093259495.png"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/image-20221105093309375.png"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/image-20221105093327827.png"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/image-20221105093535373.png"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/image-20221105095328796.png"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/image-20221105095427308.png"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/image-20221112152525928.png"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/image-20221112154704758.png"><meta property="og:image" content="https://mrhy1996.github.io/jvm-runing-area/image-20221123232124853.png"><meta property="article:published_time" content="2022-10-26T09:50:26.000Z"><meta property="article:modified_time" content="2022-11-23T15:27:03.375Z"><meta property="article:author" content="mrhy"><meta property="article:tag" content="architect"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/jvm-runing-area/image-20221021154626190.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://mrhy1996.github.io/jvm-runing-area/"},"headline":"mrhy's blogs","image":["https://mrhy1996.github.io/jvm-runing-area/image-20221021154626190.png","https://mrhy1996.github.io/jvm-runing-area/image-20221027090344896.png","https://mrhy1996.github.io/jvm-runing-area/format,png.png","https://mrhy1996.github.io/jvm-runing-area/format,png-20221030101335535.png","https://mrhy1996.github.io/jvm-runing-area/format,png-20221030185348926.png","https://mrhy1996.github.io/jvm-runing-area/format,png-20221030185613809.png","https://mrhy1996.github.io/jvm-runing-area/format,png-20221030185622802.png","https://mrhy1996.github.io/jvm-runing-area/format,png-20221030185630479.png","https://mrhy1996.github.io/jvm-runing-area/format,png-20221030185436860.png","https://mrhy1996.github.io/jvm-runing-area/format,png-20221030185455197.png","https://mrhy1996.github.io/jvm-runing-area/format,png-20221030185526481.png","https://mrhy1996.github.io/jvm-runing-area/format,png-20221030185556654.png","https://mrhy1996.github.io/jvm-runing-area/jvm运行时数据区/image-20221031213509199.png","https://mrhy1996.github.io/jvm-runing-area/image-20221031213556129.png","https://mrhy1996.github.io/jvm-runing-area/image-20221031213941263.png","https://mrhy1996.github.io/jvm-runing-area/image-20221031214856874.png","https://mrhy1996.github.io/jvm-runing-area/image-20221102092249927.png","https://mrhy1996.github.io/jvm-runing-area/image-20221103145838303.png","https://mrhy1996.github.io/jvm-runing-area/image-20221103145830147.png","https://mrhy1996.github.io/jvm-runing-area/image-20221105093134349.png","https://mrhy1996.github.io/jvm-runing-area/image-20221105093259495.png","https://mrhy1996.github.io/jvm-runing-area/image-20221105093309375.png","https://mrhy1996.github.io/jvm-runing-area/image-20221105093327827.png","https://mrhy1996.github.io/jvm-runing-area/image-20221105093535373.png","https://mrhy1996.github.io/jvm-runing-area/image-20221105095328796.png","https://mrhy1996.github.io/jvm-runing-area/image-20221105095427308.png","https://mrhy1996.github.io/jvm-runing-area/image-20221112152525928.png","https://mrhy1996.github.io/jvm-runing-area/image-20221112154704758.png","https://mrhy1996.github.io/jvm-runing-area/image-20221123232124853.png"],"datePublished":"2022-10-26T09:50:26.000Z","dateModified":"2022-11-23T15:27:03.375Z","author":{"@type":"Person","name":"mrhy"},"description":"今天重温jvm运行时的数据区，写成文档，使自己有更深的理解"}</script><link rel="canonical" href="https://mrhy1996.github.io/jvm-runing-area/"><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.12.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/logo.svg" alt="mrhy&#039;s blogs" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">归档</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a><a class="navbar-item" href="/about">关于</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/Mrhy1996/"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-10-26T09:50:26.000Z" title="2022/10/26 17:50:26">2022-10-26</time>发表</span><span class="level-item"><time dateTime="2022-11-23T15:27:03.375Z" title="2022/11/23 23:27:03">2022-11-23</time>更新</span><span class="level-item">39 分钟读完 (大约5800个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">jvm运行时数据区</h1><div class="content"><p>今天重温jvm运行时的数据区，写成文档，使自己有更深的理解</p>
<span id="more"></span>

<p>一张图镇楼</p>
<img src="/jvm-runing-area/image-20221021154626190.png" class="" title="image-20221021154626190">

<p>Java的内存布局分为5大块，分别是<code>堆区</code>、<code>方法区</code>、<code>虚拟机栈</code>、<code>本地方法栈</code>、<code>程序计数器</code>。</p>
<p><strong>按照线程是否共享：</strong> <strong>堆区</strong>和<strong>方法区</strong>是线程共享的，创建进程就创建该区域<br><strong>虚拟机栈</strong>、<strong>本地方法栈</strong>、<strong>程序计数器</strong>是线程私有的，创建线程时该区域才会产生。</p>
<h1 id="方法区"><a href="#方法区" class="headerlink" title="方法区"></a>方法区</h1><img src="/jvm-runing-area/image-20221027090344896.png" class="" title="image-20221027090344896">

<p>首先声明一点方法区只是一个概念，</p>
<p>在1.8以前实现方式是永久代（PermGen），且在jvm中开辟内存，stringTable在常量池中。</p>
<p>在1.8后，实现方式改成了元空间（Metaspace），且在本地内存中开辟</p>
<h2 id="组成"><a href="#组成" class="headerlink" title="组成"></a>组成</h2><ol>
<li><p>运行时常量池</p>
<p>首先写一段代码，然后编译成字节码文件</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestCooper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Long aa = <span class="number">3L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        aa = <span class="number">1L</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;111&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">javac -g TestCooper.java   </span><br></pre></td></tr></table></figure>

<p>然后反编译</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">javap -v   TestCooper.class</span><br></pre></td></tr></table></figure>

<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">Classfile /Users/cooper/Projects/Cooper/StudyPlan/mrhy-grow-up/mrhy-jvm/src/main/java/com/mrhy/jvm/classloader/TestCooper.class</span><br><span class="line">  Last modified 2022-10-28; size 762 bytes</span><br><span class="line">  MD5 checksum e8ce86c6f3ab010de04cb529fa73b6ff</span><br><span class="line">  Compiled from &quot;TestCooper.java&quot;</span><br><span class="line">public class com.mrhy.jvm.classloader.TestCooper</span><br><span class="line">  minor version: 0</span><br><span class="line">  major version: 52</span><br><span class="line">  flags: ACC<span class="built_in">_</span>PUBLIC, ACC<span class="built_in">_</span>SUPER</span><br><span class="line">Constant pool:</span><br><span class="line">   <span class="params">#1</span> = Methodref          <span class="params">#1</span>0.<span class="params">#2</span>7        // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">   <span class="params">#2</span> = Fieldref           <span class="params">#2</span>8.<span class="params">#2</span>9        // java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">   <span class="params">#3</span> = String             <span class="params">#3</span>0            // 111</span><br><span class="line">   <span class="params">#4</span> = Methodref          <span class="params">#3</span>1.<span class="params">#3</span>2        // java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">   <span class="params">#5</span> = Long               3l</span><br><span class="line">   <span class="params">#7</span> = Methodref          <span class="params">#3</span>3.<span class="params">#3</span>4        // java/lang/Long.valueOf:(J)Ljava/lang/Long;</span><br><span class="line">   <span class="params">#8</span> = Fieldref           <span class="params">#9</span>.<span class="params">#3</span>5         // com/mrhy/jvm/classloader/TestCooper.aa:Ljava/lang/Long;</span><br><span class="line">   <span class="params">#9</span> = Class              <span class="params">#3</span>6            // com/mrhy/jvm/classloader/TestCooper</span><br><span class="line">  <span class="params">#1</span>0 = Class              <span class="params">#3</span>7            // java/lang/Object</span><br><span class="line">  <span class="params">#1</span>1 = Utf8               aa</span><br><span class="line">  <span class="params">#1</span>2 = Utf8               Ljava/lang/Long;</span><br><span class="line">  <span class="params">#1</span>3 = Utf8               &lt;init&gt;</span><br><span class="line">  <span class="params">#1</span>4 = Utf8               ()V</span><br><span class="line">  <span class="params">#1</span>5 = Utf8               Code</span><br><span class="line">  <span class="params">#1</span>6 = Utf8               LineNumberTable</span><br><span class="line">  <span class="params">#1</span>7 = Utf8               LocalVariableTable</span><br><span class="line">  <span class="params">#1</span>8 = Utf8               this</span><br><span class="line">  <span class="params">#1</span>9 = Utf8               Lcom/mrhy/jvm/classloader/TestCooper;</span><br><span class="line">  <span class="params">#2</span>0 = Utf8               main</span><br><span class="line">  <span class="params">#2</span>1 = Utf8               ([Ljava/lang/String;)V</span><br><span class="line">  <span class="params">#2</span>2 = Utf8               args</span><br><span class="line">  <span class="params">#2</span>3 = Utf8               [Ljava/lang/String;</span><br><span class="line">  <span class="params">#2</span>4 = Utf8               &lt;clinit&gt;</span><br><span class="line">  <span class="params">#2</span>5 = Utf8               SourceFile</span><br><span class="line">  <span class="params">#2</span>6 = Utf8               TestCooper.java</span><br><span class="line">  <span class="params">#2</span>7 = NameAndType        <span class="params">#1</span>3:<span class="params">#1</span>4        // &quot;&lt;init&gt;&quot;:()V</span><br><span class="line">  <span class="params">#2</span>8 = Class              <span class="params">#3</span>8            // java/lang/System</span><br><span class="line">  <span class="params">#2</span>9 = NameAndType        <span class="params">#3</span>9:<span class="params">#4</span>0        // out:Ljava/io/PrintStream;</span><br><span class="line">  <span class="params">#3</span>0 = Utf8               111</span><br><span class="line">  <span class="params">#3</span>1 = Class              <span class="params">#4</span>1            // java/io/PrintStream</span><br><span class="line">  <span class="params">#3</span>2 = NameAndType        <span class="params">#4</span>2:<span class="params">#4</span>3        // println:(Ljava/lang/String;)V</span><br><span class="line">  <span class="params">#3</span>3 = Class              <span class="params">#4</span>4            // java/lang/Long</span><br><span class="line">  <span class="params">#3</span>4 = NameAndType        <span class="params">#4</span>5:<span class="params">#4</span>6        // valueOf:(J)Ljava/lang/Long;</span><br><span class="line">  <span class="params">#3</span>5 = NameAndType        <span class="params">#1</span>1:<span class="params">#1</span>2        // aa:Ljava/lang/Long;</span><br><span class="line">  <span class="params">#3</span>6 = Utf8               com/mrhy/jvm/classloader/TestCooper</span><br><span class="line">  <span class="params">#3</span>7 = Utf8               java/lang/Object</span><br><span class="line">  <span class="params">#3</span>8 = Utf8               java/lang/System</span><br><span class="line">  <span class="params">#3</span>9 = Utf8               out</span><br><span class="line">  <span class="params">#4</span>0 = Utf8               Ljava/io/PrintStream;</span><br><span class="line">  <span class="params">#4</span>1 = Utf8               java/io/PrintStream</span><br><span class="line">  <span class="params">#4</span>2 = Utf8               println</span><br><span class="line">  <span class="params">#4</span>3 = Utf8               (Ljava/lang/String;)V</span><br><span class="line">  <span class="params">#4</span>4 = Utf8               java/lang/Long</span><br><span class="line">  <span class="params">#4</span>5 = Utf8               valueOf</span><br><span class="line">  <span class="params">#4</span>6 = Utf8               (J)Ljava/lang/Long;</span><br><span class="line">&#123;</span><br><span class="line">  public static java.lang.Long aa;</span><br><span class="line">    descriptor: Ljava/lang/Long;</span><br><span class="line">    flags: ACC<span class="built_in">_</span>PUBLIC, ACC<span class="built_in">_</span>STATIC</span><br><span class="line"></span><br><span class="line">  public com.mrhy.jvm.classloader.TestCooper();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC<span class="built_in">_</span>PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=1, locals=1, args<span class="built_in">_</span>size=1</span><br><span class="line">         0: aload<span class="built_in">_</span>0</span><br><span class="line">         1: invokespecial <span class="params">#1</span>                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">         4: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 8: 0</span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            0       5     0  this   Lcom/mrhy/jvm/classloader/TestCooper;</span><br><span class="line"></span><br><span class="line">  public static void main(java.lang.String[]);</span><br><span class="line">    descriptor: ([Ljava/lang/String;)V</span><br><span class="line">    flags: ACC<span class="built_in">_</span>PUBLIC, ACC<span class="built_in">_</span>STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=1, args<span class="built_in">_</span>size=1</span><br><span class="line">         0: getstatic     <span class="params">#2</span>                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">         3: ldc           <span class="params">#3</span>                  // String 111</span><br><span class="line">         5: invokevirtual <span class="params">#4</span>                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V</span><br><span class="line">         8: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 16: 0</span><br><span class="line">        line 17: 8</span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            0       9     0  args   [Ljava/lang/String;</span><br><span class="line"></span><br><span class="line">  static &#123;&#125;;</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC<span class="built_in">_</span>STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=2, locals=0, args<span class="built_in">_</span>size=0</span><br><span class="line">         0: ldc2<span class="built_in">_</span>w        <span class="params">#5</span>                  // long 3l</span><br><span class="line">         3: invokestatic  <span class="params">#7</span>                  // Method java/lang/Long.valueOf:(J)Ljava/lang/Long;</span><br><span class="line">         6: putstatic     <span class="params">#8</span>                  // Field aa:Ljava/lang/Long;</span><br><span class="line">         9: lconst<span class="built_in">_</span>1</span><br><span class="line">        10: invokestatic  <span class="params">#7</span>                  // Method java/lang/Long.valueOf:(J)Ljava/lang/Long;</span><br><span class="line">        13: putstatic     <span class="params">#8</span>                  // Field aa:Ljava/lang/Long;</span><br><span class="line">        16: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 9: 0</span><br><span class="line">        line 12: 9</span><br><span class="line">        line 13: 16</span><br><span class="line">&#125;</span><br><span class="line">SourceFile: &quot;TestCooper.java&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到，一个字节码信息包含类基本信息、常量池、类方法定义（包含了虚拟机指令）</p>
<p>常量池：就是一张表，虚拟机指令根据这张常量表找到要执行的类型、方法名、参数类型、字面量等信息。</p>
<p>运行时的常量池：就是当某个类被加载的时候，他的常量池信息会加入到运行时的常量池中，并把里面的符号地址改为真实地址。</p>
</li>
</ol>
<h2 id="StringTable"><a href="#StringTable" class="headerlink" title="StringTable"></a>StringTable</h2><p>俗话说的串池，本质是一个HashTable，不可扩容</p>
<p>特性如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>、常量池中的字符串仅是符号，第一次用到时才变为对象</span><br><span class="line"><span class="number">2</span>、利用串池的机制，来避免重复创建字符串对象</span><br><span class="line"><span class="number">3</span>、字符串变量拼接的原理是 StringBuilder （<span class="number">1.8</span>）</span><br><span class="line"><span class="number">4</span>、字符串常量拼接的原理是编译期优化</span><br><span class="line"><span class="number">5</span>、可以使用 intern 方法，主动将串池中还没有的字符串对象放入串池</span><br><span class="line"><span class="number">5.1</span>、<span class="number">1.8</span> 将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有则放入串池， 会把串池中的对象返回</span><br><span class="line"><span class="number">5.2</span>、<span class="number">1.6</span> 将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有会把此对象复制一份，放入串池， 会把串池中的对象返回</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>例子：</p>
<p>先写一串代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mrhy.jvm.methodarea;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> cooper</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/28 10:11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringTableDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String a = <span class="string">&quot;a&quot;</span>;</span><br><span class="line">        String b = <span class="string">&quot;b&quot;</span>;</span><br><span class="line">        String c = <span class="string">&quot;ab&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后编译+反编译</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">javac -g StringTableDemo.java</span><br><span class="line">javap -v   StringTableDemo   </span><br></pre></td></tr></table></figure>

<p>输出如下</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">Classfile /Users/cooper/Projects/Cooper/StudyPlan/mrhy-grow-up/mrhy-jvm/src/main/java/com/mrhy/jvm/methodarea/StringTableDemo.class</span><br><span class="line">  Last modified 2022-10-28; size 534 bytes</span><br><span class="line">  MD5 checksum 296186739ed59757670edf8cc51a808b</span><br><span class="line">  Compiled from &quot;StringTableDemo.java&quot;</span><br><span class="line">public class com.mrhy.jvm.methodarea.StringTableDemo</span><br><span class="line">  minor version: 0</span><br><span class="line">  major version: 52</span><br><span class="line">  flags: ACC<span class="built_in">_</span>PUBLIC, ACC<span class="built_in">_</span>SUPER</span><br><span class="line">Constant pool:</span><br><span class="line">   <span class="params">#1</span> = Methodref          <span class="params">#6</span>.<span class="params">#2</span>4         // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">   <span class="params">#2</span> = String             <span class="params">#1</span>8            // a</span><br><span class="line">   <span class="params">#3</span> = String             <span class="params">#2</span>0            // b</span><br><span class="line">   <span class="params">#4</span> = String             <span class="params">#2</span>5            // ab</span><br><span class="line">   <span class="params">#5</span> = Class              <span class="params">#2</span>6            // com/mrhy/jvm/methodarea/StringTableDemo</span><br><span class="line">   <span class="params">#6</span> = Class              <span class="params">#2</span>7            // java/lang/Object</span><br><span class="line">   <span class="params">#7</span> = Utf8               &lt;init&gt;</span><br><span class="line">   <span class="params">#8</span> = Utf8               ()V</span><br><span class="line">   <span class="params">#9</span> = Utf8               Code</span><br><span class="line">  <span class="params">#1</span>0 = Utf8               LineNumberTable</span><br><span class="line">  <span class="params">#1</span>1 = Utf8               LocalVariableTable</span><br><span class="line">  <span class="params">#1</span>2 = Utf8               this</span><br><span class="line">  <span class="params">#1</span>3 = Utf8               Lcom/mrhy/jvm/methodarea/StringTableDemo;</span><br><span class="line">  <span class="params">#1</span>4 = Utf8               main</span><br><span class="line">  <span class="params">#1</span>5 = Utf8               ([Ljava/lang/String;)V</span><br><span class="line">  <span class="params">#1</span>6 = Utf8               args</span><br><span class="line">  <span class="params">#1</span>7 = Utf8               [Ljava/lang/String;</span><br><span class="line">  <span class="params">#1</span>8 = Utf8               a</span><br><span class="line">  <span class="params">#1</span>9 = Utf8               Ljava/lang/String;</span><br><span class="line">  <span class="params">#2</span>0 = Utf8               b</span><br><span class="line">  <span class="params">#2</span>1 = Utf8               c</span><br><span class="line">  <span class="params">#2</span>2 = Utf8               SourceFile</span><br><span class="line">  <span class="params">#2</span>3 = Utf8               StringTableDemo.java</span><br><span class="line">  <span class="params">#2</span>4 = NameAndType        <span class="params">#7</span>:<span class="params">#8</span>          // &quot;&lt;init&gt;&quot;:()V</span><br><span class="line">  <span class="params">#2</span>5 = Utf8               ab</span><br><span class="line">  <span class="params">#2</span>6 = Utf8               com/mrhy/jvm/methodarea/StringTableDemo</span><br><span class="line">  <span class="params">#2</span>7 = Utf8               java/lang/Object</span><br><span class="line">&#123;</span><br><span class="line">  public com.mrhy.jvm.methodarea.StringTableDemo();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC<span class="built_in">_</span>PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=1, locals=1, args<span class="built_in">_</span>size=1</span><br><span class="line">         0: aload<span class="built_in">_</span>0</span><br><span class="line">         1: invokespecial <span class="params">#1</span>                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">         4: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 8: 0</span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            0       5     0  this   Lcom/mrhy/jvm/methodarea/StringTableDemo;</span><br><span class="line"></span><br><span class="line">  public static void main(java.lang.String[]);</span><br><span class="line">    descriptor: ([Ljava/lang/String;)V</span><br><span class="line">    flags: ACC<span class="built_in">_</span>PUBLIC, ACC<span class="built_in">_</span>STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=1, locals=4, args<span class="built_in">_</span>size=1</span><br><span class="line">         0: ldc           <span class="params">#2</span>                  // String a</span><br><span class="line">         2: astore<span class="built_in">_</span>1</span><br><span class="line">         3: ldc           <span class="params">#3</span>                  // String b</span><br><span class="line">         5: astore<span class="built_in">_</span>2</span><br><span class="line">         6: ldc           <span class="params">#4</span>                  // String ab</span><br><span class="line">         8: astore<span class="built_in">_</span>3</span><br><span class="line">         9: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 10: 0</span><br><span class="line">        line 11: 3</span><br><span class="line">        line 12: 6</span><br><span class="line">        line 13: 9</span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            0      10     0  args   [Ljava/lang/String;</span><br><span class="line">            3       7     1     a   Ljava/lang/String;</span><br><span class="line">            6       4     2     b   Ljava/lang/String;</span><br><span class="line">            9       1     3     c   Ljava/lang/String;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>常量池中的信息，会被加载到运行时的常量池中，这时候的a，b,c都是常量池中的符号，还没有变成java字符串对象</p>
<p>此时StringTable为空[]</p>
<p>当执行到ldc  #2的时候，此时先看StringTable中有没有”a“变量，没有则会新增，会把a符号变为”a“字符串变量，</p>
<p>StringTable [“a”]</p>
<p>当执行到ldc  #3的时候，此时先看StringTable中有没有”b“变量，没有则会新增，会把a符号变为”a“字符串变量，</p>
<p>StringTable [“a”,”b”]</p>
<p>当执行到ldc  #4的时候，此时先看StringTable中有没有”ab“变量，没有则会新增，会把a符号变为”a“字符串变量</p>
<p>StringTable [“a”,”b”,”ab”]</p>
<p>再将代码变形，新增加s4</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringTableDemo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String a = <span class="string">&quot;a&quot;</span>;</span><br><span class="line">        String b = <span class="string">&quot;b&quot;</span>;</span><br><span class="line">        String f=<span class="string">&quot;a&quot;</span>;</span><br><span class="line">        String c = <span class="string">&quot;ab&quot;</span>;</span><br><span class="line">        String d = a + b;</span><br><span class="line">        System.out.println(c==d);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续编译+反编译</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">Classfile /Users/cooper/Projects/Cooper/StudyPlan/mrhy-grow-up/mrhy-jvm/src/main/java/com/mrhy/jvm/methodarea/StringTableDemo.class</span><br><span class="line">  Last modified 2022-10-28; size 984 bytes</span><br><span class="line">  MD5 checksum de818f5c9af6aca12c4e6163d5bf2109</span><br><span class="line">  Compiled from &quot;StringTableDemo.java&quot;</span><br><span class="line">public class com.mrhy.jvm.methodarea.StringTableDemo</span><br><span class="line">  minor version: 0</span><br><span class="line">  major version: 52</span><br><span class="line">  flags: ACC<span class="built_in">_</span>PUBLIC, ACC<span class="built_in">_</span>SUPER</span><br><span class="line">Constant pool:</span><br><span class="line">   <span class="params">#1</span> = Methodref          <span class="params">#1</span>2.<span class="params">#3</span>6        // java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">   <span class="params">#2</span> = String             <span class="params">#2</span>4            // a</span><br><span class="line">   <span class="params">#3</span> = String             <span class="params">#2</span>6            // b</span><br><span class="line">   <span class="params">#4</span> = String             <span class="params">#3</span>7            // ab</span><br><span class="line">   <span class="params">#5</span> = Class              <span class="params">#3</span>8            // java/lang/StringBuilder</span><br><span class="line">   <span class="params">#6</span> = Methodref          <span class="params">#5</span>.<span class="params">#3</span>6         // java/lang/StringBuilder.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">   <span class="params">#7</span> = Methodref          <span class="params">#5</span>.<span class="params">#3</span>9         // java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br><span class="line">   <span class="params">#8</span> = Methodref          <span class="params">#5</span>.<span class="params">#4</span>0         // java/lang/StringBuilder.toString:()Ljava/lang/String;</span><br><span class="line">   <span class="params">#9</span> = Fieldref           <span class="params">#4</span>1.<span class="params">#4</span>2        // java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">  <span class="params">#1</span>0 = Methodref          <span class="params">#4</span>3.<span class="params">#4</span>4        // java/io/PrintStream.println:(Z)V</span><br><span class="line">  <span class="params">#1</span>1 = Class              <span class="params">#4</span>5            // com/mrhy/jvm/methodarea/StringTableDemo</span><br><span class="line">  <span class="params">#1</span>2 = Class              <span class="params">#4</span>6            // java/lang/Object</span><br><span class="line">  <span class="params">#1</span>3 = Utf8               &lt;init&gt;</span><br><span class="line">  <span class="params">#1</span>4 = Utf8               ()V</span><br><span class="line">  <span class="params">#1</span>5 = Utf8               Code</span><br><span class="line">  <span class="params">#1</span>6 = Utf8               LineNumberTable</span><br><span class="line">  <span class="params">#1</span>7 = Utf8               LocalVariableTable</span><br><span class="line">  <span class="params">#1</span>8 = Utf8               this</span><br><span class="line">  <span class="params">#1</span>9 = Utf8               Lcom/mrhy/jvm/methodarea/StringTableDemo;</span><br><span class="line">  <span class="params">#2</span>0 = Utf8               main</span><br><span class="line">  <span class="params">#2</span>1 = Utf8               ([Ljava/lang/String;)V</span><br><span class="line">  <span class="params">#2</span>2 = Utf8               args</span><br><span class="line">  <span class="params">#2</span>3 = Utf8               [Ljava/lang/String;</span><br><span class="line">  <span class="params">#2</span>4 = Utf8               a</span><br><span class="line">  <span class="params">#2</span>5 = Utf8               Ljava/lang/String;</span><br><span class="line">  <span class="params">#2</span>6 = Utf8               b</span><br><span class="line">  <span class="params">#2</span>7 = Utf8               f</span><br><span class="line">  <span class="params">#2</span>8 = Utf8               c</span><br><span class="line">  <span class="params">#2</span>9 = Utf8               d</span><br><span class="line">  <span class="params">#3</span>0 = Utf8               StackMapTable</span><br><span class="line">  <span class="params">#3</span>1 = Class              <span class="params">#2</span>3            // &quot;[Ljava/lang/String;&quot;</span><br><span class="line">  <span class="params">#3</span>2 = Class              <span class="params">#4</span>7            // java/lang/String</span><br><span class="line">  <span class="params">#3</span>3 = Class              <span class="params">#4</span>8            // java/io/PrintStream</span><br><span class="line">  <span class="params">#3</span>4 = Utf8               SourceFile</span><br><span class="line">  <span class="params">#3</span>5 = Utf8               StringTableDemo.java</span><br><span class="line">  <span class="params">#3</span>6 = NameAndType        <span class="params">#1</span>3:<span class="params">#1</span>4        // &quot;&lt;init&gt;&quot;:()V</span><br><span class="line">  <span class="params">#3</span>7 = Utf8               ab</span><br><span class="line">  <span class="params">#3</span>8 = Utf8               java/lang/StringBuilder</span><br><span class="line">  <span class="params">#3</span>9 = NameAndType        <span class="params">#4</span>9:<span class="params">#5</span>0        // append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br><span class="line">  <span class="params">#4</span>0 = NameAndType        <span class="params">#5</span>1:<span class="params">#5</span>2        // toString:()Ljava/lang/String;</span><br><span class="line">  <span class="params">#4</span>1 = Class              <span class="params">#5</span>3            // java/lang/System</span><br><span class="line">  <span class="params">#4</span>2 = NameAndType        <span class="params">#5</span>4:<span class="params">#5</span>5        // out:Ljava/io/PrintStream;</span><br><span class="line">  <span class="params">#4</span>3 = Class              <span class="params">#4</span>8            // java/io/PrintStream</span><br><span class="line">  <span class="params">#4</span>4 = NameAndType        <span class="params">#5</span>6:<span class="params">#5</span>7        // println:(Z)V</span><br><span class="line">  <span class="params">#4</span>5 = Utf8               com/mrhy/jvm/methodarea/StringTableDemo</span><br><span class="line">  <span class="params">#4</span>6 = Utf8               java/lang/Object</span><br><span class="line">  <span class="params">#4</span>7 = Utf8               java/lang/String</span><br><span class="line">  <span class="params">#4</span>8 = Utf8               java/io/PrintStream</span><br><span class="line">  <span class="params">#4</span>9 = Utf8               append</span><br><span class="line">  <span class="params">#5</span>0 = Utf8               (Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br><span class="line">  <span class="params">#5</span>1 = Utf8               toString</span><br><span class="line">  <span class="params">#5</span>2 = Utf8               ()Ljava/lang/String;</span><br><span class="line">  <span class="params">#5</span>3 = Utf8               java/lang/System</span><br><span class="line">  <span class="params">#5</span>4 = Utf8               out</span><br><span class="line">  <span class="params">#5</span>5 = Utf8               Ljava/io/PrintStream;</span><br><span class="line">  <span class="params">#5</span>6 = Utf8               println</span><br><span class="line">  <span class="params">#5</span>7 = Utf8               (Z)V</span><br><span class="line">&#123;</span><br><span class="line">  public com.mrhy.jvm.methodarea.StringTableDemo();</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC<span class="built_in">_</span>PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=1, locals=1, args<span class="built_in">_</span>size=1</span><br><span class="line">         0: aload<span class="built_in">_</span>0</span><br><span class="line">         1: invokespecial <span class="params">#1</span>                  // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">         4: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 8: 0</span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            0       5     0  this   Lcom/mrhy/jvm/methodarea/StringTableDemo;</span><br><span class="line"></span><br><span class="line">  public static void main(java.lang.String[]);</span><br><span class="line">    descriptor: ([Ljava/lang/String;)V</span><br><span class="line">    flags: ACC<span class="built_in">_</span>PUBLIC, ACC<span class="built_in">_</span>STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=3, locals=6, args<span class="built_in">_</span>size=1</span><br><span class="line">         0: ldc           <span class="params">#2</span>                  // String a</span><br><span class="line">         2: astore<span class="built_in">_</span>1</span><br><span class="line">         3: ldc           <span class="params">#3</span>                  // String b</span><br><span class="line">         5: astore<span class="built_in">_</span>2</span><br><span class="line">         6: ldc           <span class="params">#2</span>                  // String a</span><br><span class="line">         8: astore<span class="built_in">_</span>3</span><br><span class="line">         9: ldc           <span class="params">#4</span>                  // String ab</span><br><span class="line">        11: astore        4</span><br><span class="line">        13: new           <span class="params">#5</span>                  // class java/lang/StringBuilder</span><br><span class="line">        16: dup</span><br><span class="line">        17: invokespecial <span class="params">#6</span>                  // Method java/lang/StringBuilder.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">        20: aload<span class="built_in">_</span>1</span><br><span class="line">        21: invokevirtual <span class="params">#7</span>                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br><span class="line">        24: aload<span class="built_in">_</span>2</span><br><span class="line">        25: invokevirtual <span class="params">#7</span>                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br><span class="line">        28: invokevirtual <span class="params">#8</span>                  // Method java/lang/StringBuilder.toString:()Ljava/lang/String;</span><br><span class="line">        31: astore        5</span><br><span class="line">        33: getstatic     <span class="params">#9</span>                  // Field java/lang/System.out:Ljava/io/PrintStream;</span><br><span class="line">        36: aload         4</span><br><span class="line">        38: aload         5</span><br><span class="line">        40: if<span class="built_in">_</span>acmpne     47</span><br><span class="line">        43: iconst<span class="built_in">_</span>1</span><br><span class="line">        44: goto          48</span><br><span class="line">        47: iconst<span class="built_in">_</span>0</span><br><span class="line">        48: invokevirtual <span class="params">#1</span>0                 // Method java/io/PrintStream.println:(Z)V</span><br><span class="line">        51: return</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line 10: 0</span><br><span class="line">        line 11: 3</span><br><span class="line">        line 12: 6</span><br><span class="line">        line 13: 9</span><br><span class="line">        line 14: 13</span><br><span class="line">        line 15: 33</span><br><span class="line">        line 16: 51</span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            0      52     0  args   [Ljava/lang/String;</span><br><span class="line">            3      49     1     a   Ljava/lang/String;</span><br><span class="line">            6      46     2     b   Ljava/lang/String;</span><br><span class="line">            9      43     3     f   Ljava/lang/String;</span><br><span class="line">           13      39     4     c   Ljava/lang/String;</span><br><span class="line">           33      19     5     d   Ljava/lang/String;</span><br><span class="line">      StackMapTable: number<span class="built_in">_</span>of<span class="built_in">_</span>entries = 2</span><br><span class="line">        frame<span class="built_in">_</span>type = 255 /* full<span class="built_in">_</span>frame */</span><br><span class="line">          offset<span class="built_in">_</span>delta = 47</span><br><span class="line">          locals = [ class &quot;[Ljava/lang/String;&quot;, class java/lang/String, class java/lang/String, class java/lang/String, class java/lang/String, class java/lang/String ]</span><br><span class="line">          stack = [ class java/io/PrintStream ]</span><br><span class="line">        frame<span class="built_in">_</span>type = 255 /* full<span class="built_in">_</span>frame */</span><br><span class="line">          offset<span class="built_in">_</span>delta = 0</span><br><span class="line">          locals = [ class &quot;[Ljava/lang/String;&quot;, class java/lang/String, class java/lang/String, class java/lang/String, class java/lang/String, class java/lang/String ]</span><br><span class="line">          stack = [ class java/io/PrintStream, int ]</span><br><span class="line">&#125;</span><br><span class="line">SourceFile: &quot;StringTableDemo.java&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>a+b,最后会new出一个新String，所以最后的输出结果是false</p>
<h2 id="intern方法"><a href="#intern方法" class="headerlink" title="intern方法"></a>intern方法</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Demo1_23</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  [&quot;ab&quot;, &quot;a&quot;, &quot;b&quot;]</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        String x = <span class="string">&quot;ab&quot;</span>;</span><br><span class="line">        String s = <span class="keyword">new</span> String(<span class="string">&quot;a&quot;</span>) + <span class="keyword">new</span> String(<span class="string">&quot;b&quot;</span>);</span><br><span class="line">        <span class="comment">// 堆  new String(&quot;a&quot;)   new String(&quot;b&quot;) new String(&quot;ab&quot;)</span></span><br><span class="line">        String s2 = s.intern(); <span class="comment">// 将这个字符串对象尝试放入串池，如果有则并不会放入，如果没有则放入串池， 会把串池中的对象返回</span></span><br><span class="line"></span><br><span class="line">        System.out.println( s2 == x);<span class="comment">//true</span></span><br><span class="line">        System.out.println( s == x );<span class="comment">//false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="垃圾回收"><a href="#垃圾回收" class="headerlink" title="垃圾回收"></a>垃圾回收</h2><p>StringTable有垃圾回收。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> cooper</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> -Xmx10m -XX:+PrintStringTableStatistics -XX:+PrintGCDetails -verbose:gc</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/10/29 20:48</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringTableGc</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> i=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">10000</span>; j++) &#123;</span><br><span class="line">                String.valueOf(j).intern();</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Throwable e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">[GC (Allocation Failure) [PSYoungGen: 2048K-&gt;512K(2560K)] 2048K-&gt;560K(9728K), 0.0013573 secs] [Times: user=0.01 sys=0.00, real=0.00 secs] </span><br><span class="line">10000</span><br><span class="line">Heap</span><br><span class="line"> PSYoungGen      total 2560K, used 776K [0x00000007bfd00000, 0x00000007c0000000, 0x00000007c0000000)</span><br><span class="line">  eden space 2048K, 12<span class="comment">% used [0x00000007bfd00000,0x00000007bfd42038,0x00000007bff00000)</span></span><br><span class="line">  from space 512K, 100<span class="comment">% used [0x00000007bff00000,0x00000007bff80000,0x00000007bff80000)</span></span><br><span class="line">  to   space 512K, 0<span class="comment">% used [0x00000007bff80000,0x00000007bff80000,0x00000007c0000000)</span></span><br><span class="line"> ParOldGen       total 7168K, used 48K [0x00000007bf600000, 0x00000007bfd00000, 0x00000007bfd00000)</span><br><span class="line">  object space 7168K, 0<span class="comment">% used [0x00000007bf600000,0x00000007bf60c000,0x00000007bfd00000)</span></span><br><span class="line"> Metaspace       used 2968K, capacity 4486K, committed 4864K, reserved 1056768K</span><br><span class="line">  class space    used 317K, capacity 386K, committed 512K, reserved 1048576K</span><br><span class="line">Disconnected from the target VM, address: &#x27;127.0.0.1:53535&#x27;, transport: &#x27;socket&#x27;</span><br><span class="line">SymbolTable statistics:</span><br><span class="line">Number of buckets       :     20011 =    160088 bytes, avg   8.000</span><br><span class="line">Number of entries       :     11982 =    287568 bytes, avg  24.000</span><br><span class="line">Number of literals      :     11982 =    470112 bytes, avg  39.235</span><br><span class="line">Total footprint         :           =    917768 bytes</span><br><span class="line">Average bucket size     :     0.599</span><br><span class="line">Variance of bucket size :     0.603</span><br><span class="line">Std. dev. of bucket size:     0.776</span><br><span class="line">Maximum bucket size     :         6</span><br><span class="line">StringTable statistics:</span><br><span class="line">Number of buckets       :     60013 =    480104 bytes, avg   8.000</span><br><span class="line">Number of entries       :      6315 =    151560 bytes, avg  24.000</span><br><span class="line">Number of literals      :      6315 =    343368 bytes, avg  54.373</span><br><span class="line">Total footprint         :           =    975032 bytes</span><br><span class="line">Average bucket size     :     0.105</span><br><span class="line">Variance of bucket size :     0.107</span><br><span class="line">Std. dev. of bucket size:     0.328</span><br><span class="line">Maximum bucket size     :         3</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到 number of buckets 的对象不是1w+，而是6315，且上述的输出发生了内存回收</p>
<h2 id="StringTable调优"><a href="#StringTable调优" class="headerlink" title="StringTable调优"></a>StringTable调优</h2><p>底层类似于是hashTable的结构，所以桶的数量决定查找和放的性能</p>
<p>Number of buckets       :     60013 =    480104 bytes, avg   8.000</p>
<p>默认为60013，可以通过调整*-XX:StringTableSize=100009*</p>
<h1 id="直接内存"><a href="#直接内存" class="headerlink" title="直接内存"></a>直接内存</h1><h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>Direct Memory</p>
<ul>
<li>常见于NIO操作时，用于数据缓冲区</li>
<li>分配回收成本比较高，但读写性能高</li>
<li>不受JVM内存回收管理</li>
</ul>
<h2 id="回收原理及机制"><a href="#回收原理及机制" class="headerlink" title="回收原理及机制"></a>回收原理及机制</h2><p>传统的BIO</p>
<img src="/jvm-runing-area/format,png.png" class="" title="QQ截图20220125160217">

<p>直接内存读写机制</p>
<img src="/jvm-runing-area/format,png-20221030101335535.png" class="" title="QQ截图20220125160609">

<p>直接内存的垃圾回收不是由jvm的内存回收管理的。但是java依然能主动对直接内存进行回收，其实现原理如下</p>
<img src="/jvm-runing-area/format,png-20221030185348926.png" class="" title="QQ截图20220125161420">

<p>那具体是怎么释放的呢？</p>
<p>玄机就在allocateDirect（）函数里：</p>
<p>unsafe函数释放直接内存（直接内存的释放原理）</p>
<p>那具体是怎么在底层调用unsafe的呢？我们再往下看：</p>
<img src="/jvm-runing-area/format,png-20221030185613809.png" class="" title="QQ截图20220125160924">

<p>点开allocateDirect（）</p>
<img src="/jvm-runing-area/format,png-20221030185622802.png" class="" title="QQ截图20220125162115">

<p>点开DirectByteBuffer()</p>
<img src="/jvm-runing-area/format,png-20221030185630479.png" class="" title="QQ截图20220125162843">

<p>点开Deallocator函数。</p>
<img src="/jvm-runing-area/format,png-20221030185436860.png" class="" title="QQ截图20220125162513">

<p>cleaner的clean函数会执行Dealloctor的run()方法，调用unsafe函数释放</p>
<img src="/jvm-runing-area/format,png-20221030185455197.png" class="" title="QQ截图20220125162950">

<p>显示gc导致的直接内存难以回收的应对方法</p>
<p>显示gc指的就是<code>System.gc()</code>指的是程序员写的gc。</p>
<img src="/jvm-runing-area/format,png-20221030185526481.png" class="" title="QQ截图20220125163339">



<img src="/jvm-runing-area/format,png-20221030185556654.png" class="" title="QQ截图20220125163637">

<h1 id="堆"><a href="#堆" class="headerlink" title="堆"></a>堆</h1><h2 id="垃圾回收-1"><a href="#垃圾回收-1" class="headerlink" title="垃圾回收"></a>垃圾回收</h2><h3 id="如何判断对象可以回收"><a href="#如何判断对象可以回收" class="headerlink" title="如何判断对象可以回收"></a>如何判断对象可以回收</h3><ul>
<li><p>引用计数法</p>
</li>
<li><p>可达分析法</p>
</li>
<li><p>五种引用</p>
<ol>
<li><p>强引用</p>
<ul>
<li>只有所有GC Roots对象都不通过【强引用】引用该对象，该对象才能被垃圾回收</li>
</ul>
</li>
<li><p>软引用（SoftReference）</p>
<ul>
<li>仅有软引用引用该对象时，在垃圾回收后，内存仍不足时会再次触发垃圾回收，回收软引用对象</li>
<li>可以配合引用队列来释放软引用自身（ReferenceQueue）</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReferenceDemo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> _4MB = <span class="number">4</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        soft();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">soft</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 引用队列</span></span><br><span class="line">      	<span class="comment">// list--------------&gt;SoftReference---------byte[]</span></span><br><span class="line">        ReferenceQueue&lt;<span class="keyword">byte</span>[]&gt;referenceQueue=<span class="keyword">new</span> ReferenceQueue&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        List&lt;SoftReference&lt;<span class="keyword">byte</span>[]&gt;&gt;bytes=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="comment">//关联了引用对列</span></span><br><span class="line">            SoftReference&lt;<span class="keyword">byte</span>[]&gt; ref=<span class="keyword">new</span> SoftReference&lt;&gt;(<span class="keyword">new</span> <span class="keyword">byte</span>[_4MB],referenceQueue);</span><br><span class="line">            System.out.println(ref.get());</span><br><span class="line">            bytes.add(ref);</span><br><span class="line">        &#125;</span><br><span class="line">        Reference&lt;? extends <span class="keyword">byte</span>[]&gt; poll = referenceQueue.poll();</span><br><span class="line">        <span class="keyword">while</span> (poll!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            bytes.remove(poll);</span><br><span class="line">            poll=referenceQueue.poll();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;----------------------&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (SoftReference&lt;<span class="keyword">byte</span>[]&gt; aByte : bytes) &#123;</span><br><span class="line">            System.out.println(aByte.get());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>弱引用（WeakReference）</p>
<ul>
<li>仅有弱引用引用该对象时，在垃圾回收时，无论内存是否充足，都会回收弱引用对象</li>
<li>可以配合引用队列来释放软引用自身（ReferenceQueue）</li>
</ul>
</li>
<li><p>虚引用（PhantomReference）</p>
<ul>
<li>必须配合引用队列使用，主要配合ByteBuffer使用，被引用对象回收时，会将虚引用入队列，由Reference Handler 线程调用虚引用相关方法释放内存</li>
</ul>
</li>
<li><p>终结器引用（FinalReference）</p>
<ul>
<li>无需手动编码，但其内部配合引用队列使用，在垃圾回收时，终结器引用入队（被引用对象暂时没有被回收），再由Finalizer线程通过终结器引用找到引用对象并调用他的finalize方法，第二次GC时才能回收被引用对象</li>
</ul>
</li>
</ol>
</li>
</ul>
<h2 id="垃圾回收算法"><a href="#垃圾回收算法" class="headerlink" title="垃圾回收算法"></a>垃圾回收算法</h2><h3 id="标记清除算法（Mark-Sweep）"><a href="#标记清除算法（Mark-Sweep）" class="headerlink" title="标记清除算法（Mark Sweep）"></a>标记清除算法（Mark Sweep）</h3><img src="jvm运行时数据区/image-20221031213509199.png" alt="image-20221031213509199" style="zoom:50%;" />

<h3 id="标记整理算法（Mark-Compact）"><a href="#标记整理算法（Mark-Compact）" class="headerlink" title="标记整理算法（Mark Compact）"></a>标记整理算法（Mark Compact）</h3><img src="/jvm-runing-area/image-20221031213556129.png" class="" title="image-20221031213556129">

<h3 id="复制（Copy）"><a href="#复制（Copy）" class="headerlink" title="复制（Copy）"></a>复制（Copy）</h3><img src="/jvm-runing-area/image-20221031213941263.png" class="" title="image-20221031213941263">

<h2 id="分代垃圾回收"><a href="#分代垃圾回收" class="headerlink" title="分代垃圾回收"></a>分代垃圾回收</h2><img src="/jvm-runing-area/image-20221031214856874.png" class="" title="image-20221031214856874">

<ul>
<li>对象首先分配在伊甸园区域</li>
<li>新生代空间不足时，触发 minor gc，伊甸园和 from 存活的对象使用 copy 复制到 to 中，存活的 对象年龄加 1并且交换 from to</li>
<li>minor gc 会引发 stop the world，暂停其它用户的线程，等垃圾回收结束，用户线程才恢复运行 当对象寿命超过阈值时，会晋升至老年代，最大寿命是15(4bit) </li>
<li>当老年代空间不足，会先尝试触发 minor gc，如果之后空间仍不足，那么触发 full gc，STW的时 间更长</li>
</ul>
<h3 id="相关参数"><a href="#相关参数" class="headerlink" title="相关参数"></a>相关参数</h3><ol>
<li><p>堆设置</p>
<ul>
<li><strong>-Xms</strong>:初始堆大小  默认为物理内存的1/64</li>
<li><strong>-Xmx</strong>:最大堆大小  默认为物理内存的1/4</li>
<li><strong>-Xmn</strong>:新生代大小</li>
<li><strong>-XX:NewRatio</strong>:设置新生代和老年代的比值。如：为3，表示年轻代与老年代比值为1：3</li>
<li><strong>-XX:SurvivorRatio</strong>:新生代中Eden区与两个Survivor区的比值。注意Survivor区有两个。如：为3，表示Eden：Survivor=3：2，一个Survivor区占整个新生代的1/5 </li>
<li><strong>-XX:MaxTenuringThreshold</strong>:设置转入老年代的存活次数。如果是0，则直接跳过新生代进入老年代</li>
<li><strong>-XX:PermSize</strong>、**-XX:MaxPermSize**:分别设置永久代最小大小与最大大小（Java8以前）</li>
<li><strong>-XX:MetaspaceSize</strong>、**-XX:MaxMetaspaceSize**:分别设置元空间最小大小与最大大小（Java8以后）</li>
</ul>
</li>
<li><p>收集器设置</p>
<ul>
<li><strong>-XX:+UseSerialGC</strong>:设置串行收集器</li>
<li><strong>-XX:+UseParallelGC</strong>:设置并行收集器</li>
<li><strong>-XX:+UseParalledlOldGC</strong>:设置并行老年代收集器</li>
<li><strong>-XX:+UseConcMarkSweepGC</strong>:设置并发收集器</li>
</ul>
</li>
<li><p>垃圾回收统计信息</p>
<ul>
<li><strong>-XX:+PrintGC</strong></li>
<li><strong>-XX:+PrintGCDetails</strong></li>
<li><strong>-XX:+PrintGCTimeStamps</strong></li>
<li><strong>-Xloggc:filename</strong></li>
</ul>
</li>
<li><p>并行收集器设置</p>
<ul>
<li><strong>-XX:ParallelGCThreads=n</strong>:设置并行收集器收集时使用的CPU数。并行收集线程数。</li>
<li><strong>-XX:MaxGCPauseMillis=n</strong>:设置并行收集最大暂停时间</li>
<li><strong>-XX:GCTimeRatio=n</strong>:设置垃圾回收时间占程序运行时间的百分比。公式为1/(1+n)</li>
</ul>
</li>
<li><p>并发收集器设置</p>
<ul>
<li><strong>-XX:+CMSIncrementalMode</strong>:设置为增量模式。适用于单CPU情况。</li>
<li><strong>-XX:ParallelGCThreads=n</strong>:设置并发收集器新生代收集方式为并行收集时，使用的CPU数。并行收集线程数。</li>
</ul>
</li>
</ol>
<h2 id="垃圾回收器"><a href="#垃圾回收器" class="headerlink" title="垃圾回收器"></a>垃圾回收器</h2><h3 id="串行"><a href="#串行" class="headerlink" title="串行"></a>串行</h3><ol>
<li>单线程</li>
<li>堆内存小，适合个人电脑（cpu少）</li>
</ol>
<p>-XX:+UseSerialGC = Serial + SerialOld</p>
<p>Serial 是复制算法（新生代）</p>
<p>SerialOld是老年代，采用标记整理的算法</p>
<img src="/jvm-runing-area/image-20221102092249927.png" class="" title="image-20221102092249927">

<p>单线程，进行垃圾回收的时候需要各线程跑到安全点，然后由单一垃圾回收线程的进行垃圾回收</p>
<h3 id="吞吐量优先"><a href="#吞吐量优先" class="headerlink" title="吞吐量优先"></a>吞吐量优先</h3><ol>
<li>多线程</li>
<li>堆内存大，多核cpu</li>
<li>让单位时间内，STW时间最短</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">--jdk 1.8默认的垃圾回收器</span><br><span class="line">-XX:+UseParallelGC ~ -XX:+UseParallelOldGC </span><br><span class="line">// 自动调整新生代的大小，动态调整 伊甸园和suviver的大小</span><br><span class="line">-XX:+UseAdaptiveSizePolicy </span><br><span class="line">// 调整吞吐量的大小（1/（1+ratio））,指的垃圾回收的时间的占比，调的是19</span><br><span class="line">-XX:GCTimeRatio=ratio </span><br><span class="line">// 最大暂停毫秒数  默认是200ms</span><br><span class="line">-XX:MaxGCPauseMillis=ms </span><br><span class="line">-XX:ParallelGCThreads=n</span><br></pre></td></tr></table></figure>

<img src="/jvm-runing-area/image-20221103145838303.png" class="" title="image-20221103145838303">



<h3 id="响应时间优先"><a href="#响应时间优先" class="headerlink" title="响应时间优先"></a>响应时间优先</h3><ol>
<li>多线程</li>
<li>堆内存大，多核cpu</li>
<li>尽可能让单次STW的时间最短</li>
</ol>
<p>标记清除算法</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">//如果老年代UseConcMarkSweepGC没有执行彻底，会用SerialOld 保底</span><br><span class="line">-XX:+UseConcMarkSweepGC ~ -XX:+UseParNewGC ~ SerialOld</span><br><span class="line"></span><br><span class="line">// 并行数</span><br><span class="line">-XX:ParallelGCThreads=n </span><br><span class="line">// 默认是核数的四分之一</span><br><span class="line">-XX:ConcGCThreads=threads </span><br><span class="line">-XX:CMSInitiatingOccupancyFraction=percent </span><br><span class="line">// 调优参数，做重新标记之前，做一次新生代的垃圾参数</span><br><span class="line">-XX:+CMSScavengeBeforeRemark</span><br></pre></td></tr></table></figure>

<p>只有初始标记和重新标记的时候才会stw，垃圾回收过程中会产生浮动垃圾，所以CMSInitiatingOccupancyFraction 指空间到达多少后用于垃圾回收</p>
<p>重新标记会扫描全部的堆</p>
<img src="/jvm-runing-area/image-20221103145830147.png" class="" title="image-20221103145830147">

<h3 id="G1垃圾回收期"><a href="#G1垃圾回收期" class="headerlink" title="G1垃圾回收期"></a>G1垃圾回收期</h3><h4 id="定义-1"><a href="#定义-1" class="headerlink" title="定义"></a>定义</h4><p>Garbage First</p>
<p>2004 论文发布</p>
<p>2017 JDK9 默认</p>
<h4 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h4><ul>
<li><p>同时注重吞吐量(Throughput)和低延迟(Low latency)，默认的暂停目标是 200 ms 超大堆内存</p>
</li>
<li><p>会将堆划分为多个大小相等的 Region</p>
</li>
<li><p> 整体上是 标记+整理 算法，两个区域之间是 复制 算法</p>
</li>
</ul>
<h4 id="相关jvm参数"><a href="#相关jvm参数" class="headerlink" title="相关jvm参数"></a>相关jvm参数</h4><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">-XX:+UseG1GC </span><br><span class="line">-XX:G1HeapRegionSize=size </span><br><span class="line">-XX:MaxGCPauseMillis=time</span><br></pre></td></tr></table></figure>

<h4 id="G1垃圾回收阶段"><a href="#G1垃圾回收阶段" class="headerlink" title="G1垃圾回收阶段"></a>G1垃圾回收阶段</h4><img src="/jvm-runing-area/image-20221105093134349.png" class="" title="image-20221105093134349">

<h5 id="Young-Collection"><a href="#Young-Collection" class="headerlink" title="Young Collection"></a>Young Collection</h5><p>会STW</p>
<img src="/jvm-runing-area/image-20221105093259495.png" class="" title="image-20221105093259495">

<img src="/jvm-runing-area/image-20221105093309375.png" class="" title="image-20221105093309375">

<img src="/jvm-runing-area/image-20221105093327827.png" class="" title="image-20221105093327827">

<h5 id="Young-Collection-CM"><a href="#Young-Collection-CM" class="headerlink" title="Young Collection +CM"></a>Young Collection +CM</h5><ul>
<li><p>在 Young GC 时会进行 GC Root 的初始标记 </p>
</li>
<li><p>老年代占用堆空间比例达到阈值时，进行并发标记(不会 STW)，由下面的 JVM 参数决定</p>
</li>
<li><p>-XX:InitiatingHeapOccupancyPercent=percent 默认45%的时候会触发，即整个老年代所占的比例占整个堆内存的45%</p>
</li>
</ul>
<img src="/jvm-runing-area/image-20221105093535373.png" class="" title="image-20221105093535373">

<h5 id="Mixed-Collection"><a href="#Mixed-Collection" class="headerlink" title="Mixed Collection"></a>Mixed Collection</h5><p>会对 E、S、O 进行全面垃圾回收 </p>
<ul>
<li>最终标记(Remark)会 STW</li>
<li>拷贝存活(Evacuation)会 STW </li>
<li>-XX:MaxGCPauseMillis=ms</li>
</ul>
<h4 id="Young-Collection-跨带引用问题"><a href="#Young-Collection-跨带引用问题" class="headerlink" title="Young Collection 跨带引用问题"></a>Young Collection 跨带引用问题</h4><p>新生代回收的跨代引用(老年代引用新生代)问题</p>
<img src="/jvm-runing-area/image-20221105095328796.png" class="" title="image-20221105095328796">

<ul>
<li><p>卡表与 Remembered Set</p>
</li>
<li><p> 在引用变更时通过 post-write barrier + dirty card queue</p>
</li>
<li><p>concurrent refinement threads 更新 Remembered Set</p>
</li>
</ul>
<img src="/jvm-runing-area/image-20221105095427308.png" class="" title="image-20221105095427308">

<h4 id="JDK-8u20-字符串去重"><a href="#JDK-8u20-字符串去重" class="headerlink" title="JDK 8u20 字符串去重"></a><strong>JDK 8u20</strong> <strong>字符串去重</strong></h4><ul>
<li><p>优点:节省大量内存</p>
</li>
<li><p>缺点:略微多占用了 cpu 时间，新生代回收时间略微增加 </p>
</li>
<li><p>-XX:+UseStringDeduplication</p>
</li>
</ul>
<p>将所有新分配的字符串放入一个队列 当新生代回收时，G1并发检查是否有字符串重复 如果它们值一样，让它们引用同一个 char[] 注意，与 String.intern() 不一样</p>
<p>String.intern() 关注的是字符串对象 而字符串去重关注的是 char[]<br> 在 JVM 内部，使用了不同的字符串表</p>
<h4 id="JDK-8u40-并发标记类卸载"><a href="#JDK-8u40-并发标记类卸载" class="headerlink" title="JDK 8u40 并发标记类卸载"></a><strong>JDK 8u40</strong> <strong>并发标记类卸载</strong></h4><figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">所有对象都经过并发标记后，就能知道哪些类不再被使用，当一个类加载器的所有类都不再使用，则卸</span><br><span class="line">载它所加载的所有类</span><br></pre></td></tr></table></figure>

<p>-XX:+ClassUnloadingWithConcurrentMark 默认启用</p>
<h4 id="JDK-8u60-回收巨型对象"><a href="#JDK-8u60-回收巨型对象" class="headerlink" title="JDK 8u60 回收巨型对象"></a><strong>JDK 8u60</strong> <strong>回收巨型对象</strong></h4><ul>
<li><p>一个对象大于 region 的一半时，称之为巨型对象</p>
</li>
<li><p>G1 不会对巨型对象进行拷贝</p>
</li>
<li><p>回收时被优先考虑</p>
</li>
<li><p>G1 会跟踪老年代所有 incoming 引用，这样老年代 incoming 引用为0 的巨型对象就可以在新生 代垃圾回收时处理掉</p>
</li>
</ul>
<img src="/jvm-runing-area/image-20221112152525928.png" class="" title="image-20221112152525928">



<h4 id="JDK-9-并发标记起始时间的调整"><a href="#JDK-9-并发标记起始时间的调整" class="headerlink" title="JDK 9 并发标记起始时间的调整"></a><strong>JDK 9</strong> <strong>并发标记起始时间的调整</strong></h4><p>并发标记必须在堆空间占满前完成，否则退化为 FullGC<br> JDK 9 之前需要使用 -XX:InitiatingHeapOccupancyPercent JDK 9 可以动态调整</p>
<p>-XX:InitiatingHeapOccupancyPercent 用来设置初始值 进行数据采样并动态调整<br> 总会添加一个安全的空档空间</p>
<h3 id="调优"><a href="#调优" class="headerlink" title="调优"></a>调优</h3><img src="/jvm-runing-area/image-20221112154704758.png" class="" title="image-20221112154704758">



<h4 id="最快的GC是不发生GC"><a href="#最快的GC是不发生GC" class="headerlink" title="最快的GC是不发生GC"></a>最快的GC是不发生GC</h4><h4 id="新生代调优"><a href="#新生代调优" class="headerlink" title="新生代调优"></a>新生代调优</h4><ul>
<li><p>所有的new对象都是廉价的</p>
<p>TLAB</p>
</li>
<li><p>死亡对象的回收代价是0</p>
</li>
<li><p>大部分对象用过即死</p>
</li>
<li><p>Minor GC的时间远远低于FULL GC</p>
</li>
<li><p>建议占总内存的大于25% 小于50%</p>
</li>
<li><p>新生代能容纳所有【并发量*（请求-响应）】的数据</p>
</li>
<li><p>幸存区大到【当前活跃对象+需要晋升的对象】</p>
</li>
<li><p>晋升阈值配置得当，让长时间存活对象尽快晋升</p>
<ul>
<li>–XX:MaxTenuringThreshold=threshold</li>
<li>–XX:+PringTenuringDistribution</li>
</ul>
</li>
</ul>
<h4 id="老年代调优"><a href="#老年代调优" class="headerlink" title="老年代调优"></a>老年代调优</h4><img src="/jvm-runing-area/image-20221123232124853.png" class="" title="image-20221123232124853">





<h3 id="Full-GC-总结"><a href="#Full-GC-总结" class="headerlink" title="Full GC 总结"></a>Full GC 总结</h3><h4 id="SerialGC"><a href="#SerialGC" class="headerlink" title="SerialGC"></a>SerialGC</h4><p>新生代内存不足发生的垃圾收集 - minor gc</p>
<p>老年代内存不足发生的垃圾收集 - full gc ParallelGC</p>
<h4 id="ParallelGC"><a href="#ParallelGC" class="headerlink" title="ParallelGC"></a>ParallelGC</h4><p>新生代内存不足发生的垃圾收集 - minor gc</p>
<p>老年代内存不足发生的垃圾收集 - full gc </p>
<h4 id="CMS"><a href="#CMS" class="headerlink" title="CMS"></a>CMS</h4><p>新生代内存不足发生的垃圾收集 - minor gc</p>
<p>老年代内存不足</p>
<h4 id="G1"><a href="#G1" class="headerlink" title="G1"></a>G1</h4><p>新生代内存不足发生的垃圾收集 - minor gc </p>
<p>老年代内存不足</p>
<p>总结：cms和G1垃圾回收期在老年代内存不足时，如果垃圾产生速度比垃圾回收速度快，垃圾回收就会退化为串行垃圾回收，并最终触发Full GC，但是当比垃圾回收速度慢时，则不会触发Full gc</p>
<h1 id="虚拟机栈"><a href="#虚拟机栈" class="headerlink" title="虚拟机栈"></a>虚拟机栈</h1><h1 id="程序计数器"><a href="#程序计数器" class="headerlink" title="程序计数器"></a>程序计数器</h1><p>作用： 程序计数器是内存中一块较小的内存空间，主要是用来表示当前线程所执行的字节码的行号指示器。<br>字节码解释器工作时通过计数器的值来选取下一个需要执行的字节码指令，分支、循环、跳转、异常等功能都是需要依赖这个计数器来完成。线程切换恢复到正确的执行位置都需要依靠程序计数器<br>线程私有： 每个线程都有单独的一个程序计数器，线程之间的计数器是互不影响，独立存储的<br>生命周期： 随着线程的创建而创建，随着线程的结束而消亡<br>是否有OOM问题： 程序计数器是唯一一个不会抛出OutOfMemoryError的内存区域</p>
<h1 id="本地方法栈"><a href="#本地方法栈" class="headerlink" title="本地方法栈"></a>本地方法栈</h1></div><div class="article-licensing box"><div class="licensing-title"><p>jvm运行时数据区</p><p><a href="https://mrhy1996.github.io/jvm-runing-area/">https://mrhy1996.github.io/jvm-runing-area/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>mrhy</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2022-10-26</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2022-11-23</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icon" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a><a class="icon" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a><a class="icon" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/architect/">architect</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/jvm-load/"><span class="level-item">jvm类加载的过程</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div class="content" id="valine-thread"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js"></script><script>new Valine({
            el: '#valine-thread' ,
            appId: "qqrezpoLCiXy7GuUQlTP2NPv-gzGzoHsz",
            appKey: "KzzUdvfOAtTpDcAF5mv9nQsm",
            placeholder: "有什么话想对我说，写下来吧~",
            avatar: "mm",
            
            meta: ["nick","mail","link"],
            pageSize: 10,
            lang: "zh-CN",
            
            highlight: true,
            
            
            
            
            
            requiredFields: [],
        });</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><!--!--><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-10-26T09:50:26.000Z">2022-10-26</time></p><p class="title"><a href="/jvm-runing-area/">jvm运行时数据区</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-10-21T07:26:53.000Z">2022-10-21</time></p><p class="title"><a href="/jvm-load/">jvm类加载的过程</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-10-18T03:32:51.000Z">2022-10-18</time></p><p class="title"><a href="/descartes/">笛卡尔积工具类</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-09-09T06:13:13.000Z">2022-09-09</time></p><p class="title"><a href="/SpringBootApplication/">Springboot启动源码分析</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-07-18T05:43:10.000Z">2022-07-18</time></p><p class="title"><a href="/k8s-api/">k8s的API</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2022/10/"><span class="level-start"><span class="level-item">十月 2022</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/09/"><span class="level-start"><span class="level-item">九月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/07/"><span class="level-start"><span class="level-item">七月 2022</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/06/"><span class="level-start"><span class="level-item">六月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/04/"><span class="level-start"><span class="level-item">四月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/02/"><span class="level-start"><span class="level-item">二月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2022/01/"><span class="level-start"><span class="level-item">一月 2022</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/11/"><span class="level-start"><span class="level-item">十一月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">十月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/09/"><span class="level-start"><span class="level-item">九月 2021</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/08/"><span class="level-start"><span class="level-item">八月 2021</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">六月 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">五月 2021</span></span><span class="level-end"><span class="level-item tag">13</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">四月 2021</span></span><span class="level-end"><span class="level-item tag">19</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">三月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/01/"><span class="level-start"><span class="level-item">一月 2021</span></span><span class="level-end"><span class="level-item tag">4</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">十二月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/11/"><span class="level-start"><span class="level-item">十一月 2020</span></span><span class="level-end"><span class="level-item tag">5</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">十月 2020</span></span><span class="level-end"><span class="level-item tag">6</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/09/"><span class="level-start"><span class="level-item">九月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/JVM/"><span class="tag">JVM</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/architect/"><span class="tag">architect</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/clickhouse/"><span class="tag">clickhouse</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/docker/"><span class="tag">docker</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/es/"><span class="tag">es</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/flink/"><span class="tag">flink</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/java/"><span class="tag">java</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/jenkins/"><span class="tag">jenkins</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/jvm/"><span class="tag">jvm</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/k8s/"><span class="tag">k8s</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/kafka/"><span class="tag">kafka</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/linux/"><span class="tag">linux</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/log4j2/"><span class="tag">log4j2</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/mysql/"><span class="tag">mysql</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/prometheus/"><span class="tag">prometheus</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/redis/"><span class="tag">redis</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/spring/"><span class="tag">spring</span><span class="tag">5</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%89%91%E6%8C%87offer/"><span class="tag">剑指offer</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E7%82%B9/"><span class="tag">基础知识点</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"><span class="tag">大数据</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%B7%A5%E5%85%B7/"><span class="tag">工具</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"><span class="tag">微服务</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%8E%92%E5%BA%8F%E7%AE%97%E6%B3%95/"><span class="tag">排序算法</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%BA%90%E7%A0%81/"><span class="tag">源码</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%AE%97%E6%B3%95/"><span class="tag">算法</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BA%BF%E4%B8%8A%E9%97%AE%E9%A2%98/"><span class="tag">线上问题</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"><span class="tag">设计模式</span><span class="tag">16</span></a></div></div></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="https://octodex.github.com/images/daftpunktocat-thomas.gif" alt="mrhy1996"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">mrhy1996</p><p class="is-size-6 is-block">立志登山揽月</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>中国 · 上海</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">89</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">27</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/Mrhy1996/" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/Mrhy1996"><i class="fab fa-github"></i></a></div></div></div><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#方法区"><span class="level-left"><span class="level-item">1</span><span class="level-item">方法区</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#组成"><span class="level-left"><span class="level-item">1.1</span><span class="level-item">组成</span></span></a></li><li><a class="level is-mobile" href="#StringTable"><span class="level-left"><span class="level-item">1.2</span><span class="level-item">StringTable</span></span></a></li><li><a class="level is-mobile" href="#intern方法"><span class="level-left"><span class="level-item">1.3</span><span class="level-item">intern方法</span></span></a></li><li><a class="level is-mobile" href="#垃圾回收"><span class="level-left"><span class="level-item">1.4</span><span class="level-item">垃圾回收</span></span></a></li><li><a class="level is-mobile" href="#StringTable调优"><span class="level-left"><span class="level-item">1.5</span><span class="level-item">StringTable调优</span></span></a></li></ul></li><li><a class="level is-mobile" href="#直接内存"><span class="level-left"><span class="level-item">2</span><span class="level-item">直接内存</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#定义"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">定义</span></span></a></li><li><a class="level is-mobile" href="#回收原理及机制"><span class="level-left"><span class="level-item">2.2</span><span class="level-item">回收原理及机制</span></span></a></li></ul></li><li><a class="level is-mobile" href="#堆"><span class="level-left"><span class="level-item">3</span><span class="level-item">堆</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#垃圾回收-1"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">垃圾回收</span></span></a></li><li><a class="level is-mobile" href="#垃圾回收算法"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">垃圾回收算法</span></span></a></li><li><a class="level is-mobile" href="#分代垃圾回收"><span class="level-left"><span class="level-item">3.3</span><span class="level-item">分代垃圾回收</span></span></a></li><li><a class="level is-mobile" href="#垃圾回收器"><span class="level-left"><span class="level-item">3.4</span><span class="level-item">垃圾回收器</span></span></a></li></ul></li><li><a class="level is-mobile" href="#虚拟机栈"><span class="level-left"><span class="level-item">4</span><span class="level-item">虚拟机栈</span></span></a></li><li><a class="level is-mobile" href="#程序计数器"><span class="level-left"><span class="level-item">5</span><span class="level-item">程序计数器</span></span></a></li><li><a class="level is-mobile" href="#本地方法栈"><span class="level-left"><span class="level-item">6</span><span class="level-item">本地方法栈</span></span></a></li></ul></div></div><script src="/js/toc.js" defer></script></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/logo.svg" alt="mrhy&#039;s blogs" height="28"></a><p class="is-size-7"><span>&copy; 2022 mrhy</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>